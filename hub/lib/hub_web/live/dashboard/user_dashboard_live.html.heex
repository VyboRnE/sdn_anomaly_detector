<div class="space-y-6">

  <div class="mb-4">
    <button phx-click="add_sensor" class="btn btn-primary">
      ‚ûï –î–æ–¥–∞—Ç–∏ —Å–µ–Ω—Å–æ—Ä
    </button>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü—è —Å–µ–Ω—Å–æ—Ä—ñ–≤ -->
  <table class="table-auto w-full border-collapse border border-gray-400">
    <thead>
      <tr class="bg-gray-200">
        <th class="border border-gray-300 px-4 py-2 text-left">–ù–∞–∑–≤–∞</th>
        <th class="border border-gray-300 px-4 py-2 text-left">API –ö–ª—é—á</th>
      </tr>
    </thead>
    <tbody>
      <%= for sensor <- @sensors do %>
        <tr phx-click="select_sensor" phx-value-sensor_id={sensor.id} class={"cursor-pointer
          hover:bg-gray-100 " <> if @selected_sensor && sensor.id == @selected_sensor.id, do: " bg-blue-100", else: ""
          }>
          <td class="border border-gray-300 px-4 py-2">
            <%= sensor.name %>
          </td>
          <td class="border border-gray-300 px-4 py-2">
            <%= sensor.api_key || "‚Äì" %>
          </td>
        </tr>
        <% end %>
    </tbody>
  </table>

  <!-- –î–µ—Ç–∞–ª—ñ —Å–µ–Ω—Å–æ—Ä–∞ -->
  <%= if @selected_sensor do %>
    <div class="p-4 border rounded-lg shadow-md bg-white">

      <h2 class="text-xl font-semibold mb-4">–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Å–µ–Ω—Å–æ—Ä: <%= @selected_sensor.name %>
      </h2>

      <p><strong>API –∫–ª—é—á:</strong>
        <%= @selected_sensor.api_key || "–Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ" %>
      </p>

      <!-- 1. –ó–∞–≥–∞–ª—å–Ω–∏–π —Ç—Ä–∞—Ñ—ñ–∫ + –∞–Ω–æ–º–∞–ª—ñ—ó (Time Series Overlay) -->
      <section class="mt-6">
        <h3 class="text-lg font-medium mb-2">üìä –¢—Ä–∞—Ñ—ñ–∫ —ñ –∞–Ω–æ–º–∞–ª—ñ—ó —É —á–∞—Å—ñ</h3>
        <div id="trafficAnomalyChart" phx-hook="TrafficAnomalyChart" data-chart={Jason.encode!(%{ categories:
          Enum.map(@stats, &Timex.format!(&1.time, "{ISO:Extended}" )), total_packets: Enum.map(@stats, &
          &1.total_packet_count), anomaly_flags: Enum.map(@stats, &(&1.anomaly_count || 0)) })} class="w-full h-64">
        </div>
      </section>

      <!-- 2. –†–æ–∑–ø–æ–¥—ñ–ª –ø—Ä–æ—Ç–æ–∫–æ–ª—ñ–≤ -->
      <section class="mt-6">
        <h3 class="text-lg font-medium mb-2">üîç –†–æ–∑–ø–æ–¥—ñ–ª –ø—Ä–æ—Ç–æ–∫–æ–ª—ñ–≤ —É —á–∞—Å—ñ</h3>
        <div id="protocolDistributionChart" phx-hook="ProtocolDistributionChart" data-chart={Jason.encode!(%{
          categories: Enum.map(@stats, &Timex.format!(&1.time, "{ISO:Extended}" )), tcp: Enum.map(@stats,
          &(&1.proto_tcp_count || 0)), udp: Enum.map(@stats, &(&1.proto_udp_count || 0)), icmp: Enum.map(@stats,
          &(&1.proto_icmp_count || 0)) })} class="w-full h-64"></div>
      </section>

      <!-- 3. –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è CUSUM —Ç–∞ Isolation Forest -->
      <section class="mt-6">
        <h3 class="text-lg font-medium mb-2">‚ö†Ô∏è –ê–Ω–æ–º–∞–ª—ñ—ó: CUSUM vs Isolation Forest</h3>
        <div id="anomalyComparisonChart" phx-hook="AnomalyComparisonChart" data-chart={Jason.encode!(%{ categories:
          Enum.map(@stats, &Timex.format!(&1.time, "{ISO:Extended}" )), cusum: Enum.map(@stats, &
          &1.cusum_anomaly_count), isolation: Enum.map(@stats, & &1.isolation_anomaly_count) })} class="w-full h-64">
        </div>
      </section>

      <!-- 4. –¢–æ–ø –ø–æ—Ä—Ç—ñ–≤ 
      <section class="mt-6">
        <h3 class="text-lg font-medium mb-2">üéØ –¢–æ–ø —Ü—ñ–ª—å–æ–≤–∏—Ö –ø–æ—Ä—Ç—ñ–≤</h3>
        <div id="topPortsChart" phx-hook="TopPortsChart" data-chart={Jason.encode!(%{ ports: Enum.map(@top_ports, &
          &1.port), counts: Enum.map(@top_ports, & &1.count) })} class="w-full h-64"></div>
      </section> -->

      <!-- 5. –£–Ω—ñ–∫–∞–ª—å–Ω—ñ IP —É —á–∞—Å—ñ -->
      <section class="mt-6">
        <h3 class="text-lg font-medium mb-2">üåç –£–Ω—ñ–∫–∞–ª—å–Ω—ñ IP-–∞–¥—Ä–µ—Å–∏ —É —á–∞—Å—ñ</h3>
        <div id="uniqueIpsChart" phx-hook="UniqueIpsChart" data-chart={Jason.encode!(%{ categories: Enum.map(@stats,
          &Timex.format!(&1.time, "{ISO:Extended}" )), unique_src_ips: Enum.map(@stats, & &1.total_unique_src_ips) })}
          class="w-full h-64"></div>
      </section>


    </div>
    <% else %>
      <p>–û–±–µ—Ä—ñ—Ç—å —Å–µ–Ω—Å–æ—Ä –∑—ñ —Å–ø–∏—Å–∫—É –≤–∏—â–µ, —â–æ–± –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –¥–µ—Ç–∞–ª—ñ.</p>
      <% end %>

        <%= if @show_add_form do %>
          <div class="p-4 border rounded-md shadow bg-gray-50 mt-6">
            <h3 class="text-lg font-semibold mb-2">–ù–æ–≤–∏–π —Å–µ–Ω—Å–æ—Ä</h3>
            <form phx-submit="save_sensor">
              <input type="text" name="sensor[name]" placeholder="–ù–∞–∑–≤–∞ —Å–µ–Ω—Å–æ—Ä–∞"
                class="border px-2 py-1 rounded w-1/2 mb-2" />
              <br />
              <button type="submit" class="btn btn-success">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </form>
          </div>
          <% end %>

</div>